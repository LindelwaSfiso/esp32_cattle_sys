{% extends "base.html" %}

{% block content %}

    <section class="pt-12">
        <div class="py-8 px-4 mx-auto max-w-screen-xl text-center lg:py-16">
            <h1 class="mb-4 text-4xl font-extrabold tracking-tight leading-none md:text-5xl lg:text-6xl">
                Welcome to Cattle Management System
            </h1>
            <p class="mb-8 text-lg font-normal text-gray-500 lg:text-xl sm:px-16 lg:px-48 dark:text-gray-600">
                Oversee, track, and explore insights regarding your livestock.
            </p>
        </div>
    </section>


    <section class="pt-2">
        <div class="pb-8 flex flex-col">
            <h1 class="mb-4 text-base font-extrabold tracking-tight leading-none md:text-xl lg:text-2xl">
                Esp32 Live Records
            </h1>
            <p class="text-lg font-normal text-gray-500 lg:text-xl dark:text-gray-600">
                See your Esp32 weight recordings update in realtime.
            </p>
        </div>
    </section>

    <div class="relative overflow-x-auto shadow-md sm:rounded-lg bg-gray-900 mb-10">
        <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-white">
            <thead class="text-sm text-gray-700 uppercase dark:text-white border-b border-gray-600">
            <tr>
                <th scope="col" class="px-6 py-3 bg-gray-50 dark:bg-gray-800">
                    Cow RFID Tag
                </th>
                <th scope="col" class="px-6 py-3">
                    Cow Breed
                </th>
                <th scope="col" class="px-6 py-3 bg-gray-50 dark:bg-gray-800">
                    Gender
                </th>
                <th scope="col" class="px-6 py-3">
                    Recorded At
                </th>
                <th scope="col" class="px-6 py-3 bg-gray-50 dark:bg-gray-800">
                    Weight (Kg)
                </th>
            </tr>
            </thead>
            <tbody>

            {% if records %}

                {% for record in records %}
                    <tr class="border-b border-gray-200 dark:border-gray-700">
                        <th scope="row"
                            class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap bg-gray-50 dark:text-white dark:bg-gray-800">
                            {{ record.cow.rfid }}
                        </th>
                        <td class="px-6 py-4">
                            {{ record.cow.breed }}
                        </td>
                        <td class="px-6 py-4 bg-gray-50 dark:bg-gray-800">
                            {{ record.cow.get_breed_display }}
                        </td>
                        <td class="px-6 py-4">
                            {{ record.created_at|date:'H:i d/m/Y' }}
                        </td>
                        <td class="px-6 py-4 bg-gray-50 dark:bg-gray-800">
                            {{ record.weight }}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <th scope="row" colspan="5"
                            class="text-center px-6 py-4 font-medium text-gray-900 whitespace-nowrap bg-gray-50 dark:text-white dark:bg-gray-800">
                            You have no records yet!!
                        </th>
                    </tr>
                {% endfor %}

            {% endif %}

            </tbody>
        </table>
    </div>

    <div id="toast"
         class="hidden z-[100] fixed flex items-center w-full max-w-xs p-4 space-x-4 text-gray-500 bg-white divide-x rtl:divide-x-reverse divide-gray-200 rounded-lg shadow-sm right-5 bottom-5 dark:text-gray-200 dark:divide-gray-700 dark:bg-gray-800"
         role="alert">
        <div class="text-base font-normal">
        </div>
    </div>

{% endblock %}


{% block js %}
    <script type="text/javascript">
        $(function () {
            let isSending = false;
            const toastElement = $('#toast');

            function showToast(message) {
                toastElement.find('.font-normal').text(message);
                toastElement.removeClass('hidden').addClass('flex');
                setTimeout(() => {
                    toastElement.removeClass('flex').addClass('hidden');
                }, 3000);
            }

            function fetchRecentData() {
                if (isSending) return;
                isSending = true;

                $.ajax({
                    type: 'get',
                    url: '/api/recent-data/',
                    success: function (data) {
                        console.log(data);
                        isSending = false;

                        if (data.message) {
                            showToast(data.message);
                        }

                        if (data.data && Array.isArray(data.data)) {
                            const tableBody = $('tbody');
                            tableBody.empty(); // Clear existing rows

                            if (data.data.length > 0) {
                                data.data.forEach(record => {
                                    const row = `
                                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                                <th scope="row"
                                                    class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap bg-gray-50 dark:text-white dark:bg-gray-800">
                                                    ${record.cow.rfid}
                                                </th>
                                                <td class="px-6 py-4">
                                                    ${record.cow.breed}
                                                </td>
                                                <td class="px-6 py-4 bg-gray-50 dark:bg-gray-800">
                                                    ${record.cow.breed_display}
                                                </td>
                                                <td class="px-6 py-4">
                                                    ${new Date(record.created_at).toLocaleString()}
                                                </td>
                                                <td class="px-6 py-4 bg-gray-50 dark:bg-gray-800">
                                                    ${record.weight}
                                                </td>
                                            </tr>
                                        `;
                                    tableBody.append(row);
                                });
                            } else {
                                tableBody.append(`
                                        <tr>
                                            <th scope="row" colspan="5"
                                                class="text-center px-6 py-4 font-medium text-gray-900 whitespace-nowrap bg-gray-50 dark:text-white dark:bg-gray-800">
                                                No recent records found.
                                            </th>
                                        </tr>
                                    `);
                            }
                        }
                    },
                    error: function (error) {
                        console.error("Error fetching data:", error);
                        isSending = false;
                        showToast("Error fetching recent data.");
                    }
                });
            }

            // Fetch data every 10 seconds
            setInterval(fetchRecentData, 10000);

            // Initial fetch when the page loads
            // fetchRecentData(); // We will load initial data with the Django template
        });
    </script>
{% endblock %}
